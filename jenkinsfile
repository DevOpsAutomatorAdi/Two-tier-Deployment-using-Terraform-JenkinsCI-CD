pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'DESTROY',
            defaultValue: true,
            description: 'Run destroy instead of apply'
        )
    }

    environment {
        TF_ROOT = "terraform"
        AWS_REGION = "ap-south-1"
        REPO = "https://github.com/DevOpsAutomatorAdi/Two-tier-Deployment-using-Terraform-JenkinsCI-CD.git"
    }

    stages {

        stage('Clone Repository') {
            steps {
                sh '''
                rm -rf project
                git clone $REPO project
                '''
            }
        }

        /*
        ============================
        DESTROY FLOW (RUN FIRST)
        ============================
        */

        stage('Approve Destroy') {
            when { expression { params.DESTROY } }
            steps {
                timeout(time: 20, unit: 'MINUTES') {
                    input message: "Destroy Terraform Infrastructure?", ok: "Destroy"
                }
            }
        }

        stage('Terraform Destroy') {
            when { expression { params.DESTROY } }
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
                ]) {

                    sh '''
                    cd project

                    export AWS_DEFAULT_REGION=$AWS_REGION

                    terraform -chdir=$TF_ROOT init -input=false

                    terraform -chdir=$TF_ROOT plan -destroy \
                    -var="region=$AWS_REGION"

                    terraform -chdir=$TF_ROOT destroy \
                    -var="region=$AWS_REGION" \
                    -auto-approve
                    '''
                }
            }
        }

        /*
        ============================
        APPLY FLOW
        ============================
        */

        stage('Terraform Validate') {
            when { not { expression { params.DESTROY } } }
            steps {
                sh '''
                cd project

                terraform -chdir=$TF_ROOT init -input=false
                terraform -chdir=$TF_ROOT validate
                terraform -chdir=$TF_ROOT fmt -check
                '''
            }
        }

        stage('Terraform Plan') {
            when { not { expression { params.DESTROY } } }
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
                ]) {

                    sh '''
                    cd project
                    export AWS_DEFAULT_REGION=$AWS_REGION

                    terraform -chdir=$TF_ROOT plan \
                    -var="region=$AWS_REGION" \
                    -out=tfplan
                    '''
                }
            }
        }

        stage('Approve Apply') {
            when { not { expression { params.DESTROY } } }
            steps {
                timeout(time: 20, unit: 'MINUTES') {
                    input message: "Apply Terraform Infrastructure?", ok: "Apply"
                }
            }
        }

        stage('Terraform Apply') {
            when { not { expression { params.DESTROY } } }
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']
                ]) {

                    sh '''
                    cd project
                    export AWS_DEFAULT_REGION=$AWS_REGION

                    terraform -chdir=$TF_ROOT apply \
                    -var="region=$AWS_REGION" \
                    -auto-approve

                    terraform -chdir=$TF_ROOT output -raw instance_public_ip > server_ip.txt
                    terraform -chdir=$TF_ROOT output -raw private_key > private_key.pem
                    '''
                }
            }
        }

    }

    post {
        aborted {
            echo "Pipeline aborted by user"
        }

        success {
            echo "Pipeline completed successfully"
        }

        failure {
            echo "Pipeline failed"
        }
    }
}
